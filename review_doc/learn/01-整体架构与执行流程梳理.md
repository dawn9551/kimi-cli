# 01 - Skill ä¸ MCP ååŒæœºåˆ¶ï¼šæ•´ä½“æ¶æ„ä¸æ‰§è¡Œæµç¨‹æ¢³ç†

## å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ å°†äº†è§£ï¼š
1. Skill å’Œ MCP åœ¨ Kimi CLI ä¸­çš„æ•´ä½“æ¶æ„ä½ç½®
2. ä»å¯åŠ¨åˆ°æ‰§è¡Œçš„å®Œæ•´ä»£ç å †æ ˆæµç¨‹
3. ä¸¤è€…ååŒå·¥ä½œçš„å…³é”®èŠ‚ç‚¹
4. åç»­æ·±å…¥å­¦ä¹ çš„è·¯çº¿å›¾

---

## ä¸€ã€æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    Start[ç”¨æˆ·å¯åŠ¨ kimi] --> CLI[CLI å…¥å£<br/>cli/__init__.py]
    CLI --> App[KimiCLI.create<br/>app.py]
    
    App --> Runtime[Runtime.create<br/>soul/agent.py]
    
    Runtime --> DiscoverSkills[å‘ç° Skills<br/>skill.py]
    Runtime --> LoadAgentSpec[åŠ è½½ Agent Spec<br/>agentspec.py]
    
    LoadAgentSpec --> LoadAgent[load_agent<br/>soul/agent.py]
    
    LoadAgent --> InjectSkills[æ³¨å…¥ KIMI_SKILLS<br/>åˆ°ç³»ç»Ÿæç¤ºè¯]
    LoadAgent --> LoadTools[åŠ è½½å·¥å…·<br/>toolset.py]
    
    LoadTools --> BuiltinTools[å†…ç½®å·¥å…·]
    LoadTools --> MCPTools[MCP å·¥å…·<br/>fastmcp]
    
    LoadAgent --> CreateSoul[åˆ›å»º KimiSoul<br/>kimisoul.py]
    
    CreateSoul --> RegisterSlash[æ³¨å†Œ Skill<br/>æ–œæ å‘½ä»¤]
    
    CreateSoul --> Run[è¿è¡Œä¸»å¾ªç¯<br/>run â†’ _turn â†’ _agent_loop]
    
    Run --> Step[_step: LLM è°ƒç”¨]
    
    Step --> Decision{AI å†³ç­–}
    
    Decision -- è¯»å– Skill --> ReadSkill[read_skill_text<br/>åŠ è½½ SKILL.md]
    Decision -- è°ƒç”¨å·¥å…· --> ExecuteTool[æ‰§è¡Œå·¥å…·<br/>å¯èƒ½æ˜¯ MCP]
    
    ReadSkill --> NextStep[ç»§ç»­æ‰§è¡Œ]
    ExecuteTool --> NextStep
    
    style DiscoverSkills fill:#e1f5ff
    style InjectSkills fill:#e1f5ff
    style RegisterSlash fill:#e1f5ff
    style ReadSkill fill:#e1f5ff
    
    style LoadTools fill:#ffe1e1
    style MCPTools fill:#ffe1e1
    style ExecuteTool fill:#ffe1e1
```

**å›¾ä¾‹**ï¼š
- ğŸ”µ è“è‰²æ¡†ï¼šSkill ç›¸å…³æµç¨‹
- ğŸ”´ çº¢è‰²æ¡†ï¼šMCP ç›¸å…³æµç¨‹

---

## äºŒã€ä»£ç æ‰§è¡Œå †æ ˆæ¦‚è§ˆ

### é˜¶æ®µ 1ï¸âƒ£: å¯åŠ¨ä¸åˆå§‹åŒ–

```
ğŸ“ cli/__init__.py
  â””â”€ kimi() å‡½æ•°
     â””â”€ asyncio.run(_run())
        â””â”€ è°ƒç”¨ KimiCLI.create()

ğŸ“ app.py
  â””â”€ KimiCLI.create()
     â”œâ”€ Session.create() / Session.continue_()
     â””â”€ Runtime.create()  â† å…³é”®ï¼Skill å’Œ MCP åœ¨è¿™é‡Œå¼€å§‹åˆ†å‰

ğŸ“ soul/agent.py
  â””â”€ Runtime.create()
     â”œâ”€ ğŸ”µ discover_skills_from_roots()  # Skill å‘ç°
     â”œâ”€ ğŸ”µ æ ¼å¼åŒ– KIMI_SKILLS å‚æ•°
     â””â”€ è¿”å› Runtime å®ä¾‹ï¼ˆåŒ…å« skills å­—å…¸ï¼‰
```

**å…³é”®ç‚¹**ï¼š
- `Runtime.create()` æ˜¯ Skill å’Œ MCP çš„**èµ·ç‚¹**
- Skill åœ¨è¿™ä¸ªé˜¶æ®µè¢«**å‘ç°**å’Œ**ç´¢å¼•**
- MCP å·¥å…·å°šæœªåŠ è½½ï¼ˆç¨ååœ¨ `load_agent()` ä¸­åŠ è½½ï¼‰

---

### é˜¶æ®µ 2ï¸âƒ£: Agent åŠ è½½

```
ğŸ“ soul/agent.py
  â””â”€ load_agent()
     â”œâ”€ load_agent_spec()  # åŠ è½½ YAML é…ç½®
     â”œâ”€ _load_system_prompt()
     â”‚  â””â”€ ğŸ”µ string.Template(system_prompt).substitute(
     â”‚        KIMI_SKILLS=skills_formatted  # Skill æ³¨å…¥ç³»ç»Ÿæç¤ºè¯
     â”‚     )
     â”œâ”€ KimiToolset()
     â”‚  â””â”€ toolset.load_tools()  # åŠ è½½å†…ç½®å·¥å…·
     â””â”€ ğŸ”´ toolset.load_mcp_tools()  # åŠ è½½ MCP å·¥å…·
```

**å…³é”®ç‚¹**ï¼š
- ğŸ”µ Skill é€šè¿‡**æ¨¡æ¿æ›¿æ¢**æ³¨å…¥ç³»ç»Ÿæç¤ºè¯
- ğŸ”´ MCP å·¥å…·é€šè¿‡ `fastmcp` åŠ è½½
- ä¸¤è€…éƒ½åœ¨ `load_agent()` å®Œæˆåå¯ç”¨

---

### é˜¶æ®µ 3ï¸âƒ£: Soul åˆå§‹åŒ–

```
ğŸ“ app.py
  â””â”€ KimiCLI.create() ç»§ç»­
     â””â”€ KimiSoul(agent, context=context)

ğŸ“ soul/kimisoul.py
  â””â”€ KimiSoul.__init__()
     â””â”€ ğŸ”µ self._register_skill_commands()
        â””â”€ ä¸ºæ¯ä¸ª Skill æ³¨å†Œ /skill:xxx æ–œæ å‘½ä»¤
```

**å…³é”®ç‚¹**ï¼š
- ğŸ”µ Skill æ–œæ å‘½ä»¤åœ¨è¿™é‡Œæ³¨å†Œ
- ç”¨æˆ·å¯ä»¥é€šè¿‡ `/skill:name` æ‰‹åŠ¨è§¦å‘ Skill

---

### é˜¶æ®µ 4ï¸âƒ£: ä¸»å¾ªç¯æ‰§è¡Œ

```
ğŸ“ soul/kimisoul.py
  â””â”€ KimiSoul.run(user_input)
     â”œâ”€ æ£€æŸ¥æ˜¯å¦ä¸ºæ–œæ å‘½ä»¤
     â”‚  â””â”€ å¦‚æœæ˜¯ /skill:xxx â†’ ğŸ”µ _make_skill_command()
     â”‚     â””â”€ read_skill_text() â†’ è¯»å– SKILL.md
     â”‚     â””â”€ _turn(Message(content=skill_text))
     â”‚
     â””â”€ _turn(user_message)
        â””â”€ _agent_loop()
           â””â”€ _step()
              â”œâ”€ kosong.step()  # LLM è°ƒç”¨
              â”‚  â””â”€ AI æŸ¥çœ‹ç³»ç»Ÿæç¤ºè¯ä¸­çš„ KIMI_SKILLS
              â”‚     â””â”€ AI å†³å®šæ˜¯å¦éœ€è¦è¯»å–æŸä¸ª Skill
              â”‚
              â””â”€ result.tool_results()
                 â””â”€ ğŸ”´ æ‰§è¡Œå·¥å…·ï¼ˆå¯èƒ½åŒ…æ‹¬ MCP å·¥å…·ï¼‰
```

**å…³é”®ç‚¹**ï¼š
- AI åœ¨æ¯æ¬¡ LLM è°ƒç”¨æ—¶éƒ½èƒ½çœ‹åˆ° `KIMI_SKILLS` åˆ—è¡¨
- AI å¯ä»¥**è‡ªä¸»å†³å®š**è¯»å–å“ªä¸ª Skillï¼ˆé€šè¿‡æ–‡ä»¶å·¥å…·ï¼‰
- AI å¯ä»¥è°ƒç”¨ MCP å·¥å…·æ‰§è¡Œå®é™…æ“ä½œ

---

## ä¸‰ã€Skill ä¸ MCP çš„ååŒæ—¶åˆ»

### ååŒåœºæ™¯ 1: AI è‡ªä¸»ååŒ

```
ç”¨æˆ·è¾“å…¥: "å¸®æˆ‘åˆ†æè¿™ä¸ª BigQuery æ•°æ®åº“çš„ç”¨æˆ·å¢é•¿"

æ‰§è¡Œæµç¨‹:
1. _step() è°ƒç”¨ LLM
2. LLM æŸ¥çœ‹ç³»ç»Ÿæç¤ºè¯ï¼Œå‘ç°:
   ${KIMI_SKILLS}
   - bigquery-analysis
     - Path: ~/.kimi/skills/bigquery-analysis/SKILL.md
     - Description: BigQuery æ•°æ®åˆ†æå·¥ä½œæµ

3. LLM å†³å®šè¯»å– Skill:
   ğŸ”µ è°ƒç”¨ File å·¥å…·è¯»å– SKILL.md

4. SKILL.md å†…å®¹å‘Šè¯‰ LLM:
   "ä½¿ç”¨ BigQuery MCP å·¥å…·æŸ¥è¯¢æ•°æ®"

5. LLM è°ƒç”¨ MCP å·¥å…·:
   ğŸ”´ è°ƒç”¨ bigquery_query(sql="SELECT ...")

6. è·å–ç»“æœåï¼ŒæŒ‰ Skill ä¸­çš„åˆ†ææ¡†æ¶å¤„ç†æ•°æ®
```

### ååŒåœºæ™¯ 2: ç”¨æˆ·æ˜¾å¼ååŒ

```
ç”¨æˆ·è¾“å…¥: "/skill:bigquery-analysis åˆ†æç”¨æˆ·å¢é•¿"

æ‰§è¡Œæµç¨‹:
1. run() æ£€æµ‹åˆ°æ–œæ å‘½ä»¤
2. ğŸ”µ _make_skill_command() è¢«è°ƒç”¨
3. ğŸ”µ read_skill_text() è¯»å– SKILL.md
4. å°† SKILL.md + "åˆ†æç”¨æˆ·å¢é•¿" ä½œä¸ºç”¨æˆ·æ¶ˆæ¯
5. _turn() æ‰§è¡Œï¼ŒLLM æŒ‰ Skill æŒ‡å¯¼è°ƒç”¨ MCP å·¥å…·
```

---

## å››ã€æ ¸å¿ƒæ–‡ä»¶æ¸…å•

æŒ‰ç…§æ‰§è¡Œé¡ºåºï¼Œä»¥ä¸‹æ˜¯å…³é”®æ–‡ä»¶ï¼š

| é¡ºåº | æ–‡ä»¶ | ä½œç”¨ | Skill | MCP |
|-----|------|------|-------|-----|
| 1 | `cli/__init__.py` | CLI å…¥å£ | - | - |
| 2 | `app.py` | åº”ç”¨å±‚ | - | - |
| 3 | `soul/agent.py` | Runtime/Agent ç®¡ç† | âœ… | âœ… |
| 4 | `skill.py` | Skill å‘ç°ä¸åŠ è½½ | âœ… | - |
| 5 | `agentspec.py` | Agent Spec è§£æ | - | - |
| 6 | `soul/toolset.py` | å·¥å…·é›†ç®¡ç† | - | âœ… |
| 7 | `soul/kimisoul.py` | ä¸»å¾ªç¯ | âœ… | âœ… |
| 8 | `agents/default/system.md` | ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿ | âœ… | - |

---

## äº”ã€åç»­æ·±å…¥å­¦ä¹ è·¯çº¿

### ç¬¬ 1 å±‚ï¼šåŸºç¡€å±‚ï¼ˆå·²å®Œæˆ âœ…ï¼‰
- [x] æ•´ä½“æ¶æ„æ¢³ç†
- [x] æ‰§è¡Œæµç¨‹æ¦‚è§ˆ

### ç¬¬ 2 å±‚ï¼šSkill æ·±å…¥
- [ ] **02**: `Runtime.create()` - Skill å‘ç°æœºåˆ¶è¯¦è§£
- [ ] **03**: `skill.py` - discover_skills() æºç åˆ†æ
- [ ] **04**: `_load_system_prompt()` - Skill æ³¨å…¥æœºåˆ¶
- [ ] **05**: `_register_skill_commands()` - æ–œæ å‘½ä»¤æ³¨å†Œ
- [ ] **06**: `_make_skill_command()` - Skill è§¦å‘æ‰§è¡Œ

### ç¬¬ 3 å±‚ï¼šMCP æ·±å…¥
- [ ] **07**: `toolset.py` - MCP å·¥å…·åŠ è½½æœºåˆ¶
- [ ] **08**: `load_mcp_tools()` - fastmcp é›†æˆ
- [ ] **09**: å·¥å…·æ‰§è¡Œæµç¨‹ - kosong.step()

### ç¬¬ 4 å±‚ï¼šååŒæ·±å…¥
- [ ] **10**: AI å†³ç­–æœºåˆ¶ - å¦‚ä½•é€‰æ‹© Skill
- [ ] **11**: å·¥å…·è°ƒç”¨é“¾ - Skill â†’ MCP çš„å®Œæ•´è·¯å¾„
- [ ] **12**: å®æˆ˜æ¡ˆä¾‹åˆ†æ - çœŸå®åœºæ™¯è¿½è¸ª

---

## å…­ã€æœ¬æ–‡æ¡£æ¶‰åŠçš„å…³é”®ä»£ç ç‰‡æ®µ

### ä»£ç ç‰‡æ®µ 1: Runtime.create() - å¯åŠ¨ç‚¹

```python
# src/kimi_cli/soul/agent.py:82-131

@staticmethod
async def create(
    config: Config,
    llm: LLM | None,
    session: Session,
    yolo: bool,
    skills_dir: Path | None = None,
) -> Runtime:
    # ... çœç•¥å‰é¢ä»£ç  ...
    
    # ğŸ”µ Skill å‘ç°
    builtin_skills_dir = get_builtin_skills_dir()
    if skills_dir is None:
        skills_dir = get_skills_dir()
        if not skills_dir.is_dir() and (claude_skills_dir := get_claude_skills_dir()).is_dir():
            skills_dir = claude_skills_dir
    skills_roots = [builtin_skills_dir, skills_dir]
    skills = discover_skills_from_roots(skills_roots)  # â† å…³é”®è°ƒç”¨
    skills_by_name = index_skills(skills)
    
    # ğŸ”µ æ ¼å¼åŒ– Skill ä¿¡æ¯
    skills_formatted = "\n".join(
        (
            f"- {skill.name}\n"
            f"  - Path: {skill.skill_md_file}\n"
            f"  - Description: {skill.description}"
        )
        for skill in skills
    )
    
    return Runtime(
        # ... å…¶ä»–å‚æ•° ...
        builtin_args=BuiltinSystemPromptArgs(
            # ... å…¶ä»–å‚æ•° ...
            KIMI_SKILLS=skills_formatted or "No skills found.",  # â† æ³¨å…¥
        ),
        skills=skills_by_name,  # â† ä¿å­˜åˆ° Runtime
    )
```

**å…³é”®ç‚¹**ï¼š
- `discover_skills_from_roots()` æ‰«æå¤šä¸ªç›®å½•
- æ ¼å¼åŒ–ä¸º `name + path + description` çš„åˆ—è¡¨
- é€šè¿‡ `KIMI_SKILLS` å‚æ•°ä¼ é€’ç»™ç³»ç»Ÿæç¤ºè¯

---

### ä»£ç ç‰‡æ®µ 2: load_agent() - MCP åŠ è½½ç‚¹

```python
# src/kimi_cli/soul/agent.py:194-269

async def load_agent(
    agent_file: Path,
    runtime: Runtime,
    *,
    mcp_configs: list[MCPConfig] | list[dict[str, Any]],
) -> Agent:
    # ... çœç•¥å‰é¢ä»£ç  ...
    
    # åŠ è½½å†…ç½®å·¥å…·
    toolset = KimiToolset()
    toolset.load_tools(tools, tool_deps)
    
    # ğŸ”´ åŠ è½½ MCP å·¥å…·
    if mcp_configs:
        validated_mcp_configs: list[MCPConfig] = []
        # ... éªŒè¯é…ç½® ...
        await toolset.load_mcp_tools(validated_mcp_configs, runtime)  # â† å…³é”®è°ƒç”¨
    
    return Agent(
        name=agent_spec.name,
        system_prompt=system_prompt,  # â† åŒ…å« KIMI_SKILLS
        toolset=toolset,  # â† åŒ…å« MCP å·¥å…·
        runtime=runtime,  # â† åŒ…å« skills å­—å…¸
    )
```

**å…³é”®ç‚¹**ï¼š
- `load_mcp_tools()` å¼‚æ­¥åŠ è½½ MCP æœåŠ¡å™¨
- `Agent` åŒæ—¶æŒæœ‰ç³»ç»Ÿæç¤ºè¯ï¼ˆå« Skillï¼‰å’Œå·¥å…·é›†ï¼ˆå« MCPï¼‰

---

## ä¸ƒã€æ€è€ƒé¢˜

åœ¨è¿›å…¥ä¸‹ä¸€æ­¥æ·±å…¥å­¦ä¹ ä¹‹å‰ï¼Œè¯·æ€è€ƒï¼š

1. **ä¸ºä»€ä¹ˆ Skill åœ¨ `Runtime.create()` ä¸­å‘ç°ï¼Œè€Œä¸æ˜¯æ›´æ™šï¼Ÿ**
   - æç¤ºï¼šè€ƒè™‘ç³»ç»Ÿæç¤ºè¯çš„ç”Ÿæˆæ—¶æœº

2. **ä¸ºä»€ä¹ˆ MCP å·¥å…·åœ¨ `load_agent()` ä¸­åŠ è½½ï¼Œè€Œä¸æ˜¯æ›´æ—©ï¼Ÿ**
   - æç¤ºï¼šè€ƒè™‘ Agent Spec å’Œå·¥å…·ä¾èµ–æ³¨å…¥

3. **Skill å¯ä»¥ä¸é€šè¿‡æ–œæ å‘½ä»¤è¢«ä½¿ç”¨å—ï¼Ÿ**
   - æç¤ºï¼šAI å¦‚ä½•è¯»å– SKILL.mdï¼Ÿ

---

## å…«ã€ä¸‹ä¸€æ­¥å­¦ä¹ 

æ ¹æ®ä½ çš„åé¦ˆï¼Œæˆ‘ä»¬å°†æ·±å…¥ä»¥ä¸‹å†…å®¹ä¹‹ä¸€ï¼š

**é€‰é¡¹ A**: Skill æ·±å…¥ â†’ ä» `Runtime.create()` å¼€å§‹é€è¡Œåˆ†æ  
**é€‰é¡¹ B**: MCP æ·±å…¥ â†’ ä» `load_mcp_tools()` å¼€å§‹é€è¡Œåˆ†æ  
**é€‰é¡¹ C**: å…ˆçœ‹ä¸€ä¸ªå®Œæ•´çš„ååŒæ¡ˆä¾‹è¿½è¸ª

**è¯·å‘Šè¯‰æˆ‘ä½ æƒ³å…ˆå­¦ä¹ å“ªä¸ªæ–¹å‘ï¼Œæˆ‘å°†å‡†å¤‡ä¸‹ä¸€ä»½æ–‡æ¡£ã€‚**

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…åé¦ˆ
