# kimi-cli 配置指南

## 当前问题

运行测试时出现 "LLM not set" 错误，这是因为还没有配置 LLM 模型。

## 解决方案

### 方式 1: 使用环境变量（推荐用于测试）

```bash
# 设置环境变量
export KIMI_BASE_URL="https://api.moonshot.cn/v1"
export KIMI_API_KEY="your-api-key-here"
export KIMI_MODEL_NAME="moonshot-v1-8k"

# 然后运行测试
./debug_test/test_print_mode.sh
```

或者一次性设置：

```bash
KIMI_BASE_URL="https://api.moonshot.cn/v1" \
KIMI_API_KEY="your-api-key-here" \
KIMI_MODEL_NAME="moonshot-v1-8k" \
./debug_test/test_print_mode.sh
```

### 方式 2: 编辑配置文件

编辑 `~/.kimi/config.toml`：

```toml
default_model = "moonshot-8k"
default_thinking = false

[models.moonshot-8k]
provider = "kimi"
model = "moonshot-v1-8k"
max_context_size = 8000

[providers.kimi]
type = "kimi"
base_url = "https://api.moonshot.cn/v1"
api_key = "your-api-key-here"

[loop_control]
max_steps_per_turn = 100
max_retries_per_step = 3
max_ralph_iterations = 0

[services]

[mcp.client]
tool_call_timeout_ms = 60000
```

### 方式 3: 使用其他兼容 OpenAI API 的服务

如果你有其他兼容 OpenAI API 的服务（如 Azure OpenAI, 本地 Ollama 等）：

```toml
default_model = "gpt-4"

[models.gpt-4]
provider = "openai"
model = "gpt-4"
max_context_size = 8000

[providers.openai]
type = "openai"
base_url = "https://api.openai.com/v1"  # 或你的服务地址
api_key = "your-api-key-here"
```

## 快速测试配置

### 检查配置是否生效

```bash
# 使用环境变量测试
KIMI_BASE_URL="https://api.moonshot.cn/v1" \
KIMI_API_KEY="your-key" \
KIMI_MODEL_NAME="moonshot-v1-8k" \
uv run kimi --quiet -p "测试：回复'OK'"
```

### 使用交互式设置

```bash
# 运行 setup 命令（需要在 shell 模式下）
uv run kimi

# 在 kimi shell 中输入：
/setup
```

## 常见问题

### Q1: 我没有 API Key 怎么办？

A: 你需要：
1. 注册 Moonshot AI 账号：https://platform.moonshot.cn/
2. 获取 API Key
3. 或使用其他兼容 OpenAI API 的服务

### Q2: 环境变量设置后不生效？

A: 检查：
```bash
echo $KIMI_BASE_URL
echo $KIMI_API_KEY
echo $KIMI_MODEL_NAME
```

### Q3: 如何查看当前配置？

```bash
cat ~/.kimi/config.toml
```

### Q4: 配置优先级是什么？

根据源码分析，优先级为：
1. 环境变量（最高）
2. 命令行参数 `--model`
3. 配置文件 `~/.kimi/config.toml`
4. 默认值（最低）

## 模拟测试（不需要真实 API）

如果你只是想测试 print 模式的工作流程，可以使用 mock：

```bash
# 创建一个简单的 mock 脚本
cat > /tmp/mock_kimi.sh << 'EOF'
#!/bin/bash
# Mock kimi for testing
if [[ "$*" == *"--quiet"* ]] || [[ "$*" == *"--print"* ]]; then
    echo "这是模拟的 AI 响应"
else
    echo "Mock kimi - 请使用 --print 或 --quiet 模式"
fi
EOF

chmod +x /tmp/mock_kimi.sh

# 修改测试脚本使用 mock
KIMI_CMD="/tmp/mock_kimi.sh" ./debug_test/test_print_mode.sh
```

## 配置文件完整示例

查看项目中的示例配置：

```bash
# 查看是否有示例配置
find /opt/script/kimi-cli -name "*config*example*" -o -name "*config*.sample"
```

## 下一步

1. **获取 API Key** 或使用兼容的服务
2. **选择配置方式**（环境变量或配置文件）
3. **重新运行测试**

```bash
# 配置完成后运行
./debug_test/test_print_mode.sh
```

---

**相关文档**：
- 配置管理源码：`src/kimi_cli/config.py`
- LLM 抽象层：`src/kimi_cli/llm.py`
- CLI 入口分析：`review_doc/debug/doc/01_cli_entry_analysis.md`
